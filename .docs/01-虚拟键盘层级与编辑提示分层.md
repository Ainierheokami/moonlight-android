# 虚拟键盘层级与编辑模式提示分层说明

本文档说明游戏串流画面中各叠加层（菜单、虚拟键盘、编辑模式提示、串流画面）的正确层级关系与实现位置，确保不发生错误遮挡。

## 目标层级（从上到下）

1. 菜单（最顶层）
2. 虚拟键盘（按钮 + 网格线）
3. 编辑模式提示（遮罩 + 文字）
4. 串流画面（`StreamView`）

关键约束：编辑模式提示不要叠加到虚拟键盘之上，应位于键盘与网格线之下、串流画面之上。

## 关键实现位置

- 根布局：`app/src/main/res/layout/activity_game.xml`
  - 顺序为：`backgroundTouchView` → `StreamView(surfaceView)` → `performanceOverlay` → `notificationOverlay` → `GameGridLines`。
  - 两个性能/通知层与网格线为基础叠加层，默认位于 `StreamView` 之上。
  - 新增容器：
    - `controlsOverlayContainer`：承载虚拟键盘/虚拟手柄，位于网格线之上。
    - `menuOverlayContainer`：承载编辑菜单/游戏菜单，位于最顶层，高于虚拟键盘/虚拟手柄。

- 虚拟键盘：`app/src/main/java/com/limelight/binding/input/virtual_keyboard/VirtualKeyboard.java`
  - 按钮元素通过 `frame_layout.addView(element, params)` 添加到 `streamView.getParent()`（即 `android.R.id.content` 根 `FrameLayout`）末尾，天然位于较高层级。
  - 网格线使用布局中的 `GameGridLines` 视图（同属根 `FrameLayout` 子视图），默认隐藏，在编辑相关模式下显示。

- 编辑模式提示调整：`VirtualKeyboard#showEditingOverlay()`
  - 将“遮罩 + 文字提示”插入到根 `FrameLayout` 中，位置紧跟在 `surfaceView`（串流画面）之后：
    - 遮罩层（半透明）插入索引：`indexOf(surfaceView) + 1`
    - 提示文字容器插入索引：`indexOf(surfaceView) + 2`
  - 移除 `bringToFront()` 调用，避免盖住虚拟键盘与菜单。
  - 这样可以保证：菜单 > 键盘（按钮+网格线） > 编辑提示 > 串流画面。

- 菜单层：
  - 编辑菜单：`app/src/main/java/com/limelight/heokami/EditMenu.java` / `EditMenuFragment.java`
  - 游戏菜单：`app/src/main/java/com/limelight/heokami/GameMenu.java` / `GameMenuFragment.java`
  - 均通过 Fragment 以 `add(R.id.menuOverlayContainer, ...)` 的方式附着到专用菜单容器，确保始终在虚拟键盘/手柄之上。

## 关键代码片段（引用）

`VirtualKeyboard#showEditingOverlay()` 插入层级要点：

```java
View root = context.findViewById(android.R.id.content);
FrameLayout rootLayout = (FrameLayout) root;
View stream = context.findViewById(com.limelight.R.id.surfaceView);
int insertIndex = (stream != null) ? rootLayout.indexOfChild(stream) + 1 : 1;
// 先插入遮罩
rootLayout.addView(editingOverlay, Math.min(insertIndex, rootLayout.getChildCount()), lp);
// 再插入文字提示容器
rootLayout.addView(tipContainer, Math.min(insertIndex + 1, rootLayout.getChildCount()), tlp);
// 不要 bringToFront()
```

## 注意事项

- 任何可能影响叠加顺序的新视图，如需显示在“虚拟键盘”之上，应在 `android.R.id.content` 中追加到末尾，或显式 `bringToFront()`（菜单除外，菜单已由 Fragment 保证最顶层）。
- 若未来需要在“编辑模式提示”之上、但在“虚拟键盘”之下新增层，务必调整插入索引逻辑（基于 `surfaceView` 定位的策略仍然适用）。
- `GameGridLines` 作为网格线视图，与键盘属于同一层级块，需保证显示在“编辑模式提示”之上。

## 影响范围

- 交互：编辑模式下，遮罩与提示不再遮挡虚拟键盘按钮，用户可直接操作按钮进行位置与尺寸调整。
- 菜单：菜单始终在最顶层，不被编辑提示干扰。
 - 新容器：通过 `controlsOverlayContainer` 与 `menuOverlayContainer` 实现严格分层，便于后续维护与拓展。

